################################################################################################
### BASE: shared setup for dev & prod
################################################################################################
FROM serversideup/php:8.4-fpm-nginx-alpine-v3.5.1 AS base

USER root

# Install PostgreSQL and required PHP extensions
RUN apk add --no-cache libpq-dev \
 && install-php-extensions pgsql pdo_pgsql xml soap

################################################################################################
### PROD: final image for App Runner
################################################################################################
FROM base AS prod

# App Runner uses port 8080 by default
ENV AUTORUN_ENABLED="true" \
    AUTORUN_LARAVEL_MIGRATION_ISOLATION="false" \
    AUTORUN_LARAVEL_VIEW_CACHE="false" \
    AUTORUN_LARAVEL_CONFIG_CACHE="false" \
    PHP_OPCACHE_ENABLE="1"

# Copy Laravel app source
COPY ./src /var/www/html

# Remove default Nginx HTTP config to avoid conflict
RUN rm -f /etc/nginx/site-opts.d/http.conf

# Copy your full server block to proper Nginx config location
COPY ./nginx/server.conf /etc/nginx/site-confs.d/server.conf

# Set correct permissions for Laravel folders
RUN chown -R www-data:www-data /var/www/html/storage /var/www/html/bootstrap/cache /var/www/html/public /var/www/html/database \
 && chmod -R 775 /var/www/html/storage /var/www/html/bootstrap/cache /var/www/html/public /var/www/html/database

# Add entrypoint scripts (e.g., for Laravel scheduler)
COPY --chmod=755 ./entrypoint.d/ /etc/entrypoint.d/

USER www-data

